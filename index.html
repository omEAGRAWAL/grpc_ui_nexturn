<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gRPC Playground</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --accent: #00bfa6;
            --text: #ececec;
            --muted: #9e9e9e;
            --radius: 1rem;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding: 1.5rem;
        }
        h1, h2 { color: var(--accent); margin: 0 0 0.5rem; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgb(0 0 0 / .25);
            position: relative;
        }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: var(--muted); }
        input, select, textarea, button {
            width: 100%;
            font: inherit;
            padding: 0.65rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #333;
            background: #2a2a2a;
            color: var(--text);
            margin-bottom: 0.75rem;
        }
        textarea { min-height: 120px; resize: vertical; }
        button {
            background: var(--accent);
            border: none;
            cursor: pointer;
            transition: opacity .2s ease;
        }
        button:hover { opacity: .8; }
        pre {
            background: #0d0d0d;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow: auto;
            white-space: pre-wrap;
        }
        .status {
            font-size: 0.85rem;
            margin-top: -0.5rem;
            margin-bottom: 0.75rem;
            color: var(--muted);
            min-height: 1.2rem;
        }
        .flex-row {
            display: flex;
            gap: 0.5rem;
        }
        .flex-row > * { flex: 1; }
    </style>
</head>
<body>
<h1>gRPC Playground</h1>
<div class="grid">
    <!-- Upload .proto -->
    <section class="card" id="uploadCard">
        <h2>1. Upload .proto</h2>
        <label for="protoFile">Select .proto file</label>
        <input type="file" id="protoFile" accept=".proto">
        <div class="flex-row">
            <button id="uploadBtn">Upload</button>
            <span class="status" id="uploadStatus"></span>
        </div>
    </section>

    <!-- List services -->
    <section class="card" id="servicesCard">
        <h2>2. Services</h2>
        <button id="refreshServices">Refresh Services</button>
        <pre id="serviceOutput">No services loaded.</pre>
    </section>

    <!-- Unary Call -->
    <section class="card" id="unaryCard">
        <h2>3. Unary Call</h2>
        <label for="unaryTarget">Target (host:port)</label>
        <input type="text" id="unaryTarget" placeholder="localhost:50051" value="localhost:50051">

        <div class="flex-row">
            <div>
                <label for="serviceSelect">Service</label>
                <select id="serviceSelect"><option value="">Select service</option></select>
            </div>
            <div>
                <label for="methodSelect">Method</label>
                <select id="methodSelect"><option value="">Select method</option></select>
            </div>
        </div>

        <label for="unaryPayload">JSON Request</label>
        <textarea id="unaryPayload" placeholder="{\n  \"message\": \"hello\"\n}"></textarea>

        <button id="sendUnary">Send</button>
        <pre id="unaryResponse"></pre>
    </section>

    <!-- Streaming -->
    <section class="card" id="streamCard">
        <h2>4. Streaming</h2>
        <label for="streamTarget">Target (host:port)</label>
        <input type="text" id="streamTarget" placeholder="localhost:50051" value="localhost:50051">

        <div class="flex-row">
            <div>
                <label for="streamService">Service</label>
                <select id="streamService"><option value="">Select service</option></select>
            </div>
            <div>
                <label for="streamMethod">Method</label>
                <select id="streamMethod"><option value="">Select method</option></select>
            </div>
            <div>
                <label for="streamMode">Mode</label>
                <select id="streamMode">
                    <option value="server">Server</option>
                    <option value="client">Client</option>
                    <option value="bidi" selected>Bidi</option>
                </select>
            </div>
        </div>

        <label for="streamPayload">JSON Message</label>
        <textarea id="streamPayload" placeholder="{\n  \"message\": \"ping\"\n}"></textarea>

        <div class="flex-row">
            <button id="startStream">Start</button>
            <button id="sendStream" disabled>Send</button>
            <button id="stopStream" disabled>Stop</button>
        </div>
        <pre id="streamOutput"></pre>
    </section>
</div>

<script>
    const API_BASE = "http://localhost:8081"; // Adjust if backend runs elsewhere
    const WS_BASE  = "ws://localhost:8081";

    /* Helper */
    const qs = sel => document.querySelector(sel);
    const setStatus = (id, msg) => qs(id).textContent = msg || "";

    /* Upload */
    qs('#uploadBtn').addEventListener('click', async () => {
        const file = qs('#protoFile').files[0];
        if (!file) return alert('Select a .proto file first');

        const form = new FormData();
        form.append('proto', file);
        setStatus('#uploadStatus', 'Uploading…');
        try {
            const res = await fetch(`${API_BASE}/api/upload/proto`, { method: 'POST', body: form });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || 'Upload failed');
            setStatus('#uploadStatus', 'Uploaded ✓');
            refreshServices();
        } catch (err) {
            setStatus('#uploadStatus', err.message);
        }
    });

    /* List services */
    async function refreshServices() {
        try {
            const res = await fetch(`${API_BASE}/api/listServices`);
            const json = await res.json();
            qs('#serviceOutput').textContent = JSON.stringify(json, null, 2);

            // populate dropdowns
            const serviceSelects = [qs('#serviceSelect'), qs('#streamService')];
            serviceSelects.forEach(sel => {
                sel.innerHTML = '<option value="">Select service</option>';
                Object.keys(json).forEach(svc => sel.insertAdjacentHTML('beforeend', `<option value="${svc}">${svc}</option>`));
            });
        } catch (err) {
            qs('#serviceOutput').textContent = 'Error loading services';
        }
    }
    qs('#refreshServices').addEventListener('click', refreshServices);

    // When service changes, populate method list
    ['#serviceSelect', '#streamService'].forEach(sel => {
        qs(sel).addEventListener('change', e => {
            const svc = e.target.value;
            const methods = JSON.parse(qs('#serviceOutput').textContent || '{}')[svc] || [];
            const targetSel = sel === '#serviceSelect' ? qs('#methodSelect') : qs('#streamMethod');
            targetSel.innerHTML = '<option value="">Select method</option>';
            methods.forEach(m => targetSel.insertAdjacentHTML('beforeend', `<option value="${m}">${m}</option>`));
        });
    });

    /* Unary call */
    qs('#sendUnary').addEventListener('click', async () => {
        const target  = qs('#unaryTarget').value.trim();
        const service = qs('#serviceSelect').value;
        const method  = qs('#methodSelect').value;
        const payload = qs('#unaryPayload').value.trim();
        if (!target || !service || !method || !payload) return alert('Fill all fields');
        let parsed;
        try { parsed = JSON.parse(payload || '{}'); } catch { return alert('Invalid JSON'); }

        qs('#unaryResponse').textContent = 'Loading…';
        try {
            const res = await fetch(`${API_BASE}/api/callMethod`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, service, method, data: parsed })
            });
            const txt = await res.text();
            qs('#unaryResponse').textContent = txt;
        } catch (err) {
            qs('#unaryResponse').textContent = err.message;
        }
    });

    /* Streaming */
    let ws;
    function toggleStreamControls(active) {
        qs('#sendStream').disabled = !active;
        qs('#stopStream').disabled = !active;
        qs('#startStream').disabled = active;
    }
    qs('#startStream').addEventListener('click', () => {
        const target  = qs('#streamTarget').value.trim();
        const service = qs('#streamService').value;
        const method  = qs('#streamMethod').value;
        const mode    = qs('#streamMode').value;
        if (!target || !service || !method) return alert('Fill all fields');

        ws = new WebSocket(`${WS_BASE}/grpc/ws/stream`);
        ws.onopen = () => {
            ws.send(JSON.stringify({ target, service, method, mode }));
            const firstMsg = qs('#streamPayload').value.trim();
            if (firstMsg) ws.send(firstMsg);
            toggleStreamControls(true);
            qs('#streamOutput').textContent = '';
        };
        ws.onmessage = e => {
            qs('#streamOutput').textContent += e.data + '\n';
        };
        ws.onclose = () => toggleStreamControls(false);
        ws.onerror = () => toggleStreamControls(false);
    });

    qs('#sendStream').addEventListener('click', () => {
        if (!ws || ws.readyState !== 1) return;
        const msg = qs('#streamPayload').value.trim();
        if (msg) ws.send(msg);
    });
    qs('#stopStream').addEventListener('click', () => {
        if (ws) {
            ws.send('__END__');
            ws.close();
        }
    });

    // Initial fetch
    refreshServices();
</script>
</body>
</html>
